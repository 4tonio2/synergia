# Diagramme de sÃ©quence IVR

## Flux complet de prise de rendez-vous

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User    â”‚  â”‚ Frontend â”‚  â”‚ Backend  â”‚  â”‚ Jambonz  â”‚  â”‚ OpenAI   â”‚
â”‚ Browser â”‚  â”‚ Modal    â”‚  â”‚ API      â”‚  â”‚ Server   â”‚  â”‚ GPT-4    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚ 1. Click   â”‚              â”‚              â”‚              â”‚
     â”‚  "Agenda"  â”‚              â”‚              â”‚              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚         2. Open Modal     â”‚              â”‚              â”‚
     â”‚         Request Mic Accessâ”‚              â”‚              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚ 3. Allow   â”‚              â”‚              â”‚              â”‚
     â”‚    Mic     â”‚              â”‚              â”‚              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚ 4. Start Callâ”‚              â”‚              â”‚
     â”‚            â”‚ POST /start-call             â”‚              â”‚
     â”‚            â”‚ {sdp: offer} â”‚              â”‚              â”‚
     â”‚            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚ 5. Create    â”‚              â”‚
     â”‚            â”‚              â”‚   SDP Answer â”‚              â”‚
     â”‚            â”‚              â”‚ (via Jambonz)â”‚              â”‚
     â”‚            â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚ 6. Return    â”‚              â”‚
     â”‚            â”‚              â”‚   Answer     â”‚              â”‚
     â”‚            â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚ 7. SDP Answerâ”‚              â”‚              â”‚
     â”‚            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚        8. WebRTC Connectedâ”‚              â”‚              â”‚
     â”‚        Audio Stream â—„â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚ 9. TTS       â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ "Bienvenue  â”‚
     â”‚  "Bienvenue sur CLAUDIO"  â”‚              â”‚  sur..."    â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚ 10. Speak: â”‚              â”‚              â”‚              â”‚
     â”‚ "Je veux   â”‚              â”‚              â”‚              â”‚
     â”‚  un RDV"   â”‚              â”‚              â”‚              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚ 11. STT      â”‚
     â”‚            â”‚              â”‚              â”‚ Transcribe   â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚ 12. Webhook  â”‚              â”‚
     â”‚            â”‚              â”‚ POST /appointment-webhook   â”‚
     â”‚            â”‚              â”‚ {speech:"je veux un rdv"}   â”‚
     â”‚            â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚ 13. Call GPT-4              â”‚
     â”‚            â”‚              â”‚ "Process conversation"      â”‚
     â”‚            â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚ 14. AI Response
     â”‚            â”‚              â”‚              â”‚ "Quel est   â”‚
     â”‚            â”‚              â”‚              â”‚  votre nom?"â”‚
     â”‚            â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚ 15. Return   â”‚              â”‚
     â”‚            â”‚              â”‚ Jambonz Verbsâ”‚              â”‚
     â”‚            â”‚              â”‚ [{verb:"say", text:"..."}]  â”‚
     â”‚            â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚ 16. TTS      â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ "Quel est   â”‚
     â”‚  "Quel est votre nom ?"   â”‚              â”‚  votre..."  â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚ 17. Speak: â”‚              â”‚              â”‚              â”‚
     â”‚ "Marie     â”‚              â”‚              â”‚              â”‚
     â”‚  Leclerc"  â”‚              â”‚              â”‚              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚ 18. STT      â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚ 19. Webhook  â”‚              â”‚
     â”‚            â”‚              â”‚ {speech:"Marie Leclerc"}    â”‚
     â”‚            â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚ 20. GPT-4    â”‚              â”‚
     â”‚            â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚            â”‚              â”‚ "Pour quelle date ?"        â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
     â”‚  "Pour quelle date ?"     â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚ 21. "Le    â”‚              â”‚              â”‚              â”‚
     â”‚  20 mars"  â”‚              â”‚              â”‚              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚           ... (similar flow for doctor) ...             â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚ 22. All data â”‚              â”‚
     â”‚            â”‚              â”‚ collected    â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚ 23. GPT-4    â”‚              â”‚
     â”‚            â”‚              â”‚ Extraction   â”‚              â”‚
     â”‚            â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚ 24. JSON     â”‚
     â”‚            â”‚              â”‚              â”‚ {person:"...",
     â”‚            â”‚              â”‚              â”‚  date:"...", â”‚
     â”‚            â”‚              â”‚              â”‚  complete:âœ“} â”‚
     â”‚            â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚ 25. Save Dataâ”‚              â”‚
     â”‚            â”‚              â”‚ & Hangup     â”‚              â”‚
     â”‚            â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
     â”‚  "Merci, au revoir !"     â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚ 26. Call     â”‚              â”‚              â”‚
     â”‚            â”‚    Ended     â”‚              â”‚              â”‚
     â”‚            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚ 27. Fetch RDVâ”‚              â”‚              â”‚
     â”‚            â”‚ GET /last-appointment        â”‚              â”‚
     â”‚            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚ 28. Return   â”‚              â”‚              â”‚
     â”‚            â”‚ JSON Data    â”‚              â”‚              â”‚
     â”‚            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚        29. Display RDV    â”‚              â”‚              â”‚
     â”‚        in Modal           â”‚              â”‚              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚ 30. Add toâ”‚              â”‚              â”‚              â”‚
     â”‚   Calendarâ”‚              â”‚              â”‚              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚ 31. Toast: â”‚              â”‚              â”‚              â”‚
     â”‚ "RDV ajoutÃ©"              â”‚              â”‚              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
     â”‚ 32. Close  â”‚              â”‚              â”‚              â”‚
     â”‚    Modal   â”‚              â”‚              â”‚              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚              â”‚              â”‚
     â”‚            â”‚              â”‚              â”‚              â”‚
```

## LÃ©gende

- `â”€â”€â”€â”€â”€>` : Appel synchrone / requÃªte
- `<â”€â”€â”€â”€â”€` : RÃ©ponse
- `â—„â”€â”€â”€â”€â”€` : Flux audio bidirectionnel
- `...` : RÃ©pÃ©tition du pattern

## Temps estimÃ©s

| Ã‰tape | Description | DurÃ©e |
|-------|-------------|-------|
| 1-8 | Initialisation WebRTC | ~2-3s |
| 9 | Message d'accueil | ~3s |
| 10-22 | Conversation (3 Q&A) | ~45-90s |
| 23-24 | Extraction GPT-4 | ~1s |
| 25-26 | Fin d'appel | ~2s |
| 27-32 | Affichage rÃ©sultats | ~1s |
| **TOTAL** | **~54-101s** | **~1-2 min** |

## CoÃ»ts estimÃ©s par appel

| Service | Usage | CoÃ»t |
|---------|-------|------|
| Google TTS | ~50 caractÃ¨res | $0.0008 |
| Google STT | ~30 secondes | $0.0045 |
| GPT-4 Turbo | ~2000 tokens | $0.04 |
| **TOTAL** | | **~$0.045** |

*BasÃ© sur les tarifs de janvier 2026*

## Points critiques

### ðŸ”´ Critical Path
- Ã‰tapes 13-14 : Appel GPT-4 (latence ~800ms)
- Ã‰tapes 23-24 : Extraction finale (~500ms)

### ðŸŸ¡ Potential Failures
- Ã‰tape 3 : Permission micro refusÃ©e
- Ã‰tape 5 : Ã‰chec connexion Jambonz
- Ã‰tape 13 : Rate limit OpenAI
- Ã‰tape 18 : Reconnaissance vocale imprÃ©cise

### ðŸŸ¢ Optimizations
- Cache les rÃ©ponses communes
- ParallÃ©liser TTS + extraction
- PrÃ©-charger les modÃ¨les GPT-4
- Utiliser streaming pour GPT-4

## Notes techniques

### WebRTC SDP Exchange
```
Browser                 Backend              Jambonz
   â”‚                       â”‚                    â”‚
   â”‚â”€â”€createOffer()â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
   â”‚                       â”‚                    â”‚
   â”‚â”€â”€SDP Offerâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
   â”‚                       â”‚â”€â”€Forward SDPâ”€â”€â”€â”€â”€â”€>â”‚
   â”‚                       â”‚                    â”‚
   â”‚                       â”‚<â”€â”€SDP Answerâ”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚<â”€â”€SDP Answerâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
   â”‚                       â”‚                    â”‚
   â”‚â”€â”€setRemoteDescription()                    â”‚
   â”‚                       â”‚                    â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€RTP Media Streamâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
```

### Webhook Request/Response
```json
// REQUEST from Jambonz
{
  "call_sid": "abc-123",
  "from": "+33612345678",
  "to": "+33987654321",
  "call_status": "in-progress",
  "speech": "je veux un rendez-vous",
  "direction": "inbound"
}

// RESPONSE to Jambonz
[
  {
    "verb": "say",
    "text": "Quel est votre nom complet ?",
    "voice": "Google.fr-FR-Standard-A"
  },
  {
    "verb": "listen",
    "actionHook": "/api/ivr/appointment-webhook",
    "timeout": 10,
    "transcribe": {
      "language": "fr-FR"
    }
  }
]
```

---

**CrÃ©Ã© le : 2026-01-05**
**Version : 1.0**
